<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      #start-button {
        position: absolute;
        z-index: 9999;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 10px 20px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <button id="start-button">Start AR</button>
    <a-scene
      id="ar-scene"
      style="display: none;"
      mindar-image="imageTargetSrc: targets.mind; uiError:no; uiScanning:no; autoStart: false;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <!-- Use preload="auto" for better loading on iOS -->
        <audio loop id="audio-0" src="audio/mp3/audio0.mp3" preload="auto"></audio>
        <audio loop id="audio-1" src="audio/mp3/audio1.mp3" preload="auto"></audio>
        <audio loop id="audio-2" src="audio/mp3/audio2.mp3" preload="auto"></audio>
        <audio loop id="audio-3" src="audio/mp3/audio3.mp3" preload="auto"></audio>
        <audio loop id="audio-4" src="audio/mp3/audio4.mp3" preload="auto"></audio>
        <audio loop id="audio-5" src="audio/mp3/audio5.mp3" preload="auto"></audio>
        <audio loop id="audio-6" src="audio/mp3/audio6.mp3" preload="auto"></audio>
        <audio loop id="audio-7" src="audio/mp3/audio7.mp3" preload="auto"></audio>
        <audio loop id="audio-8" src="audio/mp3/audio8.mp3" preload="auto"></audio>
        <audio loop id="audio-9" src="audio/mp3/audio9.mp3" preload="auto"></audio>
      </a-assets>

      <a-camera
        position="0 0 0"
        look-controls="enabled: false"
        cursor="fuse: false; rayOrigin: mouse;"
        raycaster="near: 10; far: 10000;"
      ></a-camera>

      <!-- AR targets -->
      <a-entity id="target-0" mindar-image-target="targetIndex: 0"></a-entity>
      <a-entity id="target-1" mindar-image-target="targetIndex: 1"></a-entity>
      <a-entity id="target-2" mindar-image-target="targetIndex: 2"></a-entity>
      <a-entity id="target-3" mindar-image-target="targetIndex: 3"></a-entity>
      <a-entity id="target-4" mindar-image-target="targetIndex: 4"></a-entity>
      <a-entity id="target-5" mindar-image-target="targetIndex: 5"></a-entity>
      <a-entity id="target-6" mindar-image-target="targetIndex: 6"></a-entity>
      <a-entity id="target-7" mindar-image-target="targetIndex: 7"></a-entity>
      <a-entity id="target-8" mindar-image-target="targetIndex: 8"></a-entity>
      <a-entity id="target-9" mindar-image-target="targetIndex: 9"></a-entity>
    </a-scene>

    <script>
      const startButton = document.getElementById("start-button");
      const sceneEl = document.querySelector("a-scene");

      const allAudios = Array.from({ length: 10 }, (_, i) =>
        document.querySelector(`#audio-${i}`)
      );

      const stopAllAudio = () => {
        allAudios.forEach((audio) => {
          audio.pause();
          audio.currentTime = 0;
        });
      };

      const resumeAudioContext = () => {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (AudioContext) {
          const context = new AudioContext();
          if (context.state === "suspended") {
            context.resume().then(() => {
              console.log("AudioContext resumed");
            });
          }
        }
      };

      let currentPlayingIndex = null;
      let arSystemReady = false;
      let arSystem;

      sceneEl.addEventListener("loaded", () => {
        arSystem = sceneEl.systems["mindar-image-system"];
        arSystemReady = true;
        console.log("A-Frame scene loaded and AR system is ready.");
      });

      startButton.addEventListener("click", () => {
        startButton.style.display = "none";
        sceneEl.style.display = "block";
        resumeAudioContext();

        // Unlock all audio elements on iOS
        allAudios.forEach((audio) => {
          audio.play().then(() => {
            audio.pause();
            audio.currentTime = 0;
          }).catch((err) => {
            console.warn("Audio unlock failed:", err);
          });
        });

        // Start AR
        if (arSystemReady && arSystem) {
          arSystem.start();
        } else {
          sceneEl.addEventListener("loaded", () => {
            arSystem = sceneEl.systems["mindar-image-system"];
            arSystem.start();
            console.log("Fallback: AR system started after scene load.");
          });
        }

        // Target listeners
        for (let i = 0; i < 10; i++) {
          const target = document.querySelector(`#target-${i}`);
          const audio = document.querySelector(`#audio-${i}`);

          target.addEventListener("targetFound", () => {
            console.log(`Target ${i} found`);

            if (currentPlayingIndex !== i) {
              stopAllAudio();
              currentPlayingIndex = i;

              audio.play().catch((e) =>
                console.warn(`Audio ${i} play failed:`, e)
              );
            }
          });

          target.addEventListener("targetLost", () => {
            console.log(`Target ${i} lost`);
            // Keep audio playing
          });
        }
      });
    </script>
  </body>
</html>
